function init(){const t=d3.select("body").append("div").attr("class","hover-tooltip").style("position","absolute").style("visibility","hidden").style("background-color","#333").style("color","#fff").style("padding","5px 10px").style("border-radius","5px").style("font-family","Arial, sans-serif").style("font-size","12px");d3.select("body").append("div").attr("class","toolbar").style("position","fixed").style("top",0).style("left",0).style("width","100%").style("height","50px").style("background-color","#333").style("display","flex").style("align-items","center").style("justify-content","flex-end").style("padding","0 20px").style("box-shadow","0 2px 4px rgba(0, 0, 0, 0.1)").append("button").attr("class","toggle-btn").text("Toggle 2D/3D").style("background-color","#fff").style("border","none").style("padding","10px 20px").style("border-radius","5px").style("cursor","pointer").style("margin-right","50px").on("click",toggleView);const e=50,l=width-panelWidth-mapRightBuffer;projection=d3.geoMercator().scale(120).translate([(l-panelWidth)/2,(height-e)/1.5+mapTopBuffer]),path=d3.geoPath().projection(projection);const o=d3.select("#map-container").append("svg").attr("width",width).attr("height",height-e);map2D=o.append("g").attr("transform",`translate(${panelWidth+panelBuffer}, ${mapTopBuffer+e})`),map3D=o.append("g").attr("transform",`translate(${panelWidth+panelBuffer}, ${e})`).style("display","none"),d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(n=>{const r=topojson.feature(n,n.objects.countries);map2D.selectAll("path").data(r.features).enter().append("path").attr("d",path).attr("fill","#ccc").attr("stroke","#fff").on("mouseover",function(e,l){highlightCountry(e,l),t.style("visibility","visible").text(l.properties.name)}).on("mousemove",function(e){t.style("top",e.pageY-10+"px").style("left",e.pageX+10+"px")}).on("mouseout",function(e,l){resetHighlight(e,l),t.style("visibility","hidden")}).on("click",showTooltip).on("dblclick",showDetailedPanel),projection=d3.geoOrthographic().scale(250).translate([l/2,(height-e)/2]).clipAngle(90),path.projection(projection),map3D.selectAll("path").data(r.features).enter().append("path").attr("d",path).attr("fill","#ccc").attr("stroke","#fff").on("mouseover",function(e,l){highlightCountry(e,l),t.style("visibility","visible").text(l.properties.name)}).on("mousemove",function(e){t.style("top",e.pageY-10+"px").style("left",e.pageX+10+"px")}).on("mouseout",function(e,l){resetHighlight(e,l),t.style("visibility","hidden")}).on("click",showTooltip).on("dblclick",showDetailedPanel),o.call(d3.drag().on("start",dragStarted).on("drag",dragged).on("end",dragEnded))})}function highlightCountry(t){"selected"!==d3.select(t.target).attr("class")&&d3.select(t.target).attr("fill","#f0f0f0")}function resetHighlight(t){"selected"!==d3.select(t.target).attr("class")&&d3.select(t.target).attr("fill","#ccc")}function showTooltip(t,e){closeDetailedPanel(),currentTooltip&&(currentTooltip.remove(),currentTooltip=null),deselectCountry(),selectedCountryId=e.id,d3.select(t.target).attr("fill","#f0f0f0").attr("class","selected"),currentTooltip=d3.select("body").append("div").attr("class","tooltip").style("position","absolute").style("background-color","rgba(0, 0, 0, 0.7)").style("color","#fff").style("padding","10px").style("border-radius","5px").style("font-family","Arial, sans-serif").style("font-size","14px").style("pointer-events","auto").style("left",t.pageX+10+"px").style("top",t.pageY-25+"px"),d3.json(`data/${e.properties.name}.json`).then(t=>{let e='<span class="close-btn" style="cursor:pointer;">&times;</span>';e+=`<h3 style="margin: 0 0 10px;">${t.name}</h3>`;for(const[l,o]of Object.entries(t.info))e+=`<p style="margin: 5px 0;"><strong>${l}:</strong> ${o}</p>`;e+=`<p style="margin-top: 10px;"><a href="${t.source}" target="_blank" style="color: #ccc; text-decoration: underline;">Source</a></p>`,currentTooltip.html(e),currentTooltip.select(".close-btn").on("click",()=>{closeTooltip()})})["catch"](()=>{currentTooltip.html(`<span class="close-btn" style="cursor:pointer;">&times;</span><p>Data not available for ${e.properties.name}</p>`),currentTooltip.select(".close-btn").on("click",()=>{closeTooltip()})})}function showDetailedPanel(t,e){currentTooltip&&(currentTooltip.remove(),currentTooltip=null),d3.select(".detailed-panel").remove();const l=d3.select("body").append("div").attr("class","detailed-panel").style("position","fixed").style("top","70px").style("left","20px").style("width",panelWidth+"px").style("height",height-60-20+"px").style("background-color","#333").style("color","#fff").style("padding","15px").style("border-radius","5px").style("overflow-y","auto").style("box-shadow","0 2px 5px rgba(0, 0, 0, 0.3)");l.append("span").attr("class","close-btn").html("&times;").style("position","absolute").style("top","10px").style("right","10px").style("cursor","pointer").on("click",()=>{l.remove(),currentTooltip=null,d3.selectAll("path").filter(t=>t.id===selectedCountryId).attr("fill","#ccc").attr("class",""),selectedCountryId=null}),d3.json(`data/${e.properties.name}.json`).then(t=>{let e=`<h2>${t.name}</h2>`;for(const[l,o]of Object.entries(t.detailedInfo))e+=`<p><strong>${l}:</strong> ${o}</p>`;e+=`<p><a href="${t.source}" target="_blank">Source</a></p>`,l.append("div").html(e)})["catch"](()=>{l.append("div").html(`<p>Detailed data not available for ${e.properties.name}</p>`)})}function closeTooltip(){currentTooltip&&(currentTooltip.remove(),currentTooltip=null),deselectCountry()}function closeDetailedPanel(){detailedPanel&&(detailedPanel.remove(),detailedPanel=null),deselectCountry()}function deselectCountry(){selectedCountryId&&(d3.selectAll("path").filter(t=>t.id===selectedCountryId).attr("fill","#ccc").attr("class",""),selectedCountryId=null)}function toggleView(){"2D"===currentView?(map2D.style("display","none"),map3D.style("display","block"),currentView="3D"):(map3D.style("display","none"),map2D.style("display","block"),currentView="2D");const t=width-panelWidth-mapRightBuffer;projection.translate([t/2,height/2]),selectedCountryId&&d3.selectAll("path").filter(t=>t.id===selectedCountryId).attr("fill","#f0f0f0").attr("class","selected")}function dragStarted(){"3D"===currentView&&(rotation=projection.rotate())}function dragged(t){if("3D"===currentView){const e=[t.dx,t.dy];rotation[0]+=e[0]/2,rotation[1]-=e[1]/2,projection.rotate(rotation),map3D.selectAll("path").attr("d",path)}}function dragEnded(){}let map2D,map3D,projection,path,currentView="2D",currentTooltip=null,detailedPanel=null,selectedCountryId=null;const width=window.innerWidth,height=window.innerHeight;let rotation=[0,0];const mapRightBuffer=50,mapTopBuffer=-10,panelBuffer=30,panelWidth=width/3;init();